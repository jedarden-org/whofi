name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build ESP32 Firmware
  build-firmware:
    runs-on: jedarden-org-apexalgo-iad-runners
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install ESP-IDF Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
    
    - name: Install ESP-IDF
      run: |
        mkdir -p ~/esp
        cd ~/esp
        git clone -b v5.1.2 --recursive https://github.com/espressif/esp-idf.git
        cd esp-idf
        ./install.sh esp32,esp32s3
    
    - name: Build ESP32 Firmware
      working-directory: csi-firmware
      run: |
        . ~/esp/esp-idf/export.sh
        idf.py build
    
    - name: Run Firmware Tests
      working-directory: csi-firmware
      run: |
        . ~/esp/esp-idf/export.sh
        cd test
        chmod +x run_tests.sh
        ./run_tests.sh
    
    - name: Package Firmware
      working-directory: csi-firmware
      run: |
        mkdir -p release
        cp build/bootloader/bootloader.bin release/
        cp build/partition_table/partition-table.bin release/
        cp build/csi_positioning_firmware.bin release/
        cp build/flash_args release/
        echo "WhōFi ESP32 Firmware" > release/README.txt
        echo "Flash with: esptool.py write_flash @flash_args" >> release/README.txt
        tar -czf whofi-firmware-${{ github.sha }}.tar.gz -C release .
    
    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: esp32-firmware
        path: csi-firmware/whofi-firmware-*.tar.gz
        retention-days: 30

  # Build Unified Docker Container
  build-unified-docker:
    runs-on: jedarden-org-apexalgo-iad-runners
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/whofi-unified
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: Build and push unified Docker image
      uses: docker/build-push-action@v5
      with:
        context: csi-server
        file: csi-server/Dockerfile.unified
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Install TDD test dependencies
      run: |
        cd tests
        npm install
    
    - name: Run unified container TDD integration tests
      run: |
        cd tests
        npm run test:docker
      env:
        DOCKER_IMAGE: ${{ env.REGISTRY }}/${{ github.repository_owner }}/whofi-unified:${{ github.sha }}

    - name: Run ESP32 telemetry simulation tests
      run: |
        cd tests
        npm run test:telemetry
      env:
        DOCKER_IMAGE: ${{ env.REGISTRY }}/${{ github.repository_owner }}/whofi-unified:${{ github.sha }}

  # Create Release
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-firmware, build-unified-docker]
    runs-on: jedarden-org-apexalgo-iad-runners
    permissions:
      contents: write
      packages: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Download firmware artifact
      uses: actions/download-artifact@v4
      with:
        name: esp32-firmware
        path: ./artifacts
    
    - name: Create Release Notes
      run: |
        cat > release-notes.md << EOF
        # WhōFi Release ${{ github.ref_name }}
        
        ## 🚀 What's New
        
        This release includes the latest ESP32 firmware and Docker images for the WhōFi CSI positioning system.
        
        ## 📦 Assets
        
        ### ESP32 Firmware
        - Download the firmware package below
        - Flash using: \`esptool.py write_flash @flash_args\`
        
        ### Unified Docker Image
        - **New**: Unified container combining frontend and backend: \`ghcr.io/jedarden-org/whofi-unified:${{ github.ref_name }}\`
        - Exposes only port 80 for both UI access and ESP32 API endpoints
        - Optimized with rate limiting and security headers
        - Built-in TDD integration tests for seamless operation
        
        ## 🔧 Quick Start
        
        \`\`\`bash
        # Pull unified Docker image
        docker pull ghcr.io/jedarden-org/whofi-unified:${{ github.ref_name }}
        
        # Run unified container (single port exposure)
        docker run -d -p 80:80 --name whofi-system \\
          -e NODE_ENV=production \\
          ghcr.io/jedarden-org/whofi-unified:${{ github.ref_name }}
        
        # Access UI: http://localhost
        # ESP32 API: http://localhost/api/
        \`\`\`
        
        ## 📚 Documentation
        
        See the [README](https://github.com/jedarden-org/whofi#readme) for detailed setup instructions.
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release-notes.md
        files: |
          ./artifacts/*.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Documentation
  build-docs:
    runs-on: jedarden-org-apexalgo-iad-runners
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build Documentation Site
      run: |
        npm init -y
        npm install --save-dev vitepress
        mkdir -p docs/.vitepress
        mkdir -p docs/guide
        mkdir -p docs/api
        cat > docs/.vitepress/config.js << 'EOF'
        export default {
          title: 'WhōFi',
          description: 'WiFi CSI-based positioning system',
          base: '/whofi/',
          themeConfig: {
            nav: [
              { text: 'Home', link: '/' },
              { text: 'Guide', link: '/guide/' },
              { text: 'API', link: '/api/' }
            ],
            sidebar: [
              {
                text: 'Getting Started',
                items: [
                  { text: 'Introduction', link: '/guide/' },
                  { text: 'Installation', link: '/guide/installation' },
                  { text: 'Configuration', link: '/guide/configuration' }
                ]
              }
            ]
          }
        }
        EOF
        cp README-original.md docs/index.md || echo "# WhōFi Documentation" > docs/index.md
        echo "# Getting Started" > docs/guide/index.md
        echo "# Installation Guide" > docs/guide/installation.md
        echo "# Configuration" > docs/guide/configuration.md
        echo "# API Reference" > docs/api/index.md
        echo "Configuring VitePress to ignore dead links..." && \
        sed -i 's/}/  ignoreDeadLinks: true\n}/' docs/.vitepress/config.js && \
        npx vitepress build docs || echo "Documentation build skipped"
    
    - name: Upload docs artifact
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/.vitepress/dist
        retention-days: 30